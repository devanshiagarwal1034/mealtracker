<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Annapurna ‚Äî 2026 Meal Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,700;9..144,900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --cream:#F7F7FA; --warm:#FFFFFF; --text:#0D0D14;
  --text-mid:#4A4A6A; --text-light:#8888AA;
  --border:#E4E4EF; --shadow:0 2px 20px rgba(13,13,40,0.08); --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{font-family:'DM Sans',sans-serif;background:#F7F7FA;color:var(--text);min-height:100vh;overflow-x:hidden;}
#app{min-height:100vh;}

/* TYPOGRAPHY */
.logo-text{font-family:'Fraunces',serif;font-size:2.8rem;font-weight:900;color:#C2185B;letter-spacing:-1px;line-height:1;}
.logo-tagline{font-size:0.82rem;color:var(--text-mid);font-weight:500;margin-top:4px;letter-spacing:0.5px;}

/* BUTTONS */
.btn-primary{background:linear-gradient(135deg,#C2185B,#7B1FA2);color:white;border:none;border-radius:14px;padding:15px 24px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:1rem;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 20px rgba(194,24,91,0.35);}
.btn-primary:active{transform:scale(0.97);}
.btn-primary.full-width{width:100%;}
.icon-btn{background:rgba(255,255,255,0.2);border:none;border-radius:10px;width:36px;height:36px;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text);}
.icon-btn.light{color:white;}
.icon-btn:active{opacity:0.7;}

/* SPLASH */
.splash{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden;}
.splash-bg{position:absolute;inset:0;background:linear-gradient(160deg,#F7F7FA 0%,#EDE7F6 50%,#FCE4EC 100%);z-index:0;}
.splash-bg::before{content:'';position:absolute;top:-100px;right:-80px;width:300px;height:300px;background:radial-gradient(circle,rgba(194,24,91,0.12),transparent 70%);}
.splash-bg::after{content:'';position:absolute;bottom:-80px;left:-60px;width:250px;height:250px;background:radial-gradient(circle,rgba(123,31,162,0.1),transparent 70%);}
.splash-content{position:relative;z-index:1;width:100%;max-width:380px;text-align:center;display:flex;flex-direction:column;gap:28px;}
.splash-logo{display:flex;flex-direction:column;align-items:center;gap:6px;}
.logo-icon{font-size:3.5rem;filter:drop-shadow(0 4px 12px rgba(194,24,91,0.25));animation:float 3s ease-in-out infinite;}
.logo-icon.small{font-size:1.8rem;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.splash-features{display:flex;flex-direction:column;gap:10px;background:white;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);}
.feat-item{display:flex;align-items:center;gap:10px;font-size:0.88rem;color:var(--text-mid);font-weight:500;}
.feat-item span{font-size:1.1rem;}
.splash-note{font-size:0.72rem;color:var(--text-light);}

/* AUTH */
.auth-screen{min-height:100vh;padding:24px;display:flex;flex-direction:column;align-items:center;gap:24px;background:linear-gradient(160deg,#F7F7FA,#EDE7F6);padding-top:60px;}
.auth-header{display:flex;flex-direction:column;align-items:center;gap:6px;}
.auth-title{font-family:'Fraunces',serif;font-size:1.8rem;font-weight:700;color:#C2185B;}
.auth-card{width:100%;max-width:380px;background:white;border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);}
.auth-tabs{display:flex;gap:0;background:#EEECF8;border-radius:10px;padding:4px;margin-bottom:20px;}
.auth-tab{flex:1;padding:9px;border-radius:8px;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.85rem;cursor:pointer;color:var(--text-mid);transition:all 0.2s;}
.auth-tab.active{background:white;color:#C2185B;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.form-group{margin-bottom:16px;}
.form-group label{display:block;font-size:0.78rem;font-weight:600;color:var(--text-mid);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;}
.form-group input{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.95rem;color:var(--text);background:#FAFAFD;outline:none;transition:border 0.2s;}
.form-group input:focus{border-color:#C2185B;background:white;}
.auth-error{background:#FFF0EE;border:1px solid #F0A89A;color:#C0392B;padding:10px 12px;border-radius:8px;font-size:0.82rem;margin-bottom:14px;}

/* HOME */
.home-screen{min-height:100vh;display:flex;flex-direction:column;background:#F7F7FA;}
.home-header{padding:20px 18px 16px;color:white;border-radius:0 0 28px 28px;}
.home-header-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
.home-greeting{font-family:'Fraunces',serif;font-size:1.5rem;font-weight:700;line-height:1.1;}
.home-date{font-size:0.78rem;opacity:0.85;margin-top:3px;}
.festival-chip{background:rgba(255,255,255,0.2);border-radius:20px;padding:6px 12px;font-size:0.78rem;font-weight:500;display:inline-block;}
.home-body{flex:1;padding:18px 16px;padding-bottom:80px;}
.section-label{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-light);margin-bottom:10px;}
.month-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
.month-card{background:white;border-radius:16px;overflow:hidden;cursor:pointer;box-shadow:0 2px 12px rgba(13,13,40,0.08);transition:all 0.18s;}
.month-card:active{transform:scale(0.95);}
.mc-bar{height:6px;width:100%;}
.mc-body{padding:10px 6px 12px;}
.mc-name{font-size:0.78rem;font-weight:700;color:var(--text);letter-spacing:0.2px;}
.mc-dot{width:5px;height:5px;border-radius:50%;margin:5px auto 0;}
.shared-list{display:flex;flex-direction:column;gap:8px;}
.shared-card{display:flex;align-items:center;gap:12px;background:white;border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);cursor:pointer;transition:all 0.15s;}
.shared-card:active{transform:scale(0.98);}
.shared-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;color:white;flex-shrink:0;}
.shared-info{flex:1;min-width:0;}
.shared-name{font-weight:600;font-size:0.9rem;}
.shared-email{font-size:0.72rem;color:var(--text-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.shared-arrow{font-size:1.1rem;}
.share-btn{width:100%;padding:14px 18px;background:linear-gradient(135deg,#1565C0,#00695C);border:none;border-radius:14px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.2s;box-shadow:0 4px 16px rgba(21,101,192,0.25);}
.share-btn:active{transform:scale(0.98);opacity:0.92;}
.share-btn-icon{width:32px;height:32px;background:rgba(255,255,255,0.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}

/* PLANNER */
.planner-screen{min-height:100vh;display:flex;flex-direction:column;background:#F7F7FA;}
.planner-topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;color:white;transition:background 0.35s ease;}
.planner-title{text-align:center;}
.pt-month{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:white;}
.pt-shared{font-size:0.7rem;opacity:0.85;margin-top:2px;}
.month-strip{display:flex;overflow-x:auto;padding:8px 10px;gap:4px;background:white;border-bottom:1px solid var(--border);scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.month-strip::-webkit-scrollbar{display:none;}
.ms-item{flex-shrink:0;padding:5px 8px;border-radius:20px;font-size:0.68rem;font-weight:700;cursor:pointer;color:var(--text-mid);background:#F0EEF8;transition:all 0.15s;}
.week-tabs{display:flex;overflow-x:auto;background:white;border-bottom:2px solid var(--border);scrollbar-width:none;}
.week-tabs::-webkit-scrollbar{display:none;}
.wt-item{flex:1;min-width:0;padding:8px 4px;text-align:center;font-size:0.7rem;font-weight:700;cursor:pointer;color:var(--text-mid);position:relative;white-space:nowrap;border-bottom:2.5px solid transparent;transition:all 0.15s;}
.wt-item.active{color:#C2185B;}
.wt-dates{display:block;font-size:0.58rem;font-weight:500;opacity:0.65;margin-top:1px;}
.wt-dot{display:inline-block;width:5px;height:5px;border-radius:50%;margin-left:2px;vertical-align:middle;}
.fest-banner{padding:8px 16px;color:white;font-size:0.78rem;font-weight:600;text-align:center;}
.day-cards{display:flex;flex-direction:column;gap:10px;padding:12px;}
.day-card{background:white;border-radius:14px;overflow:hidden;box-shadow:var(--shadow);}
.dc-header{padding:10px 12px;display:flex;align-items:center;gap:10px;}
.dc-date-block{flex-shrink:0;text-align:center;width:36px;}
.dc-dayname{font-size:0.58rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-light);}
.dc-daynum{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:900;line-height:1;}
.dc-fest-tags{display:flex;flex-wrap:wrap;gap:4px;}
.dc-fest-tag{font-size:0.58rem;font-weight:700;padding:2px 7px;border-radius:20px;}
.dc-today-tag{font-size:0.58rem;font-weight:700;padding:2px 7px;border-radius:20px;background:#FCE4EC;color:#C2185B;}
.dc-weekend-tag{font-size:0.58rem;font-weight:600;padding:2px 7px;border-radius:20px;background:#EDE7F6;color:#6A1B9A;}
.dc-meals{padding:6px 12px 12px;display:flex;flex-direction:column;gap:6px;}
.dc-meal-row{display:flex;align-items:flex-start;gap:8px;}
.dc-meal-label{font-size:0.85rem;padding-top:8px;flex-shrink:0;}
.dc-meal-input{flex:1;min-height:34px;border:1.5px solid var(--border);border-radius:8px;padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--text);background:#FAFAFD;outline:none;transition:border 0.15s;word-break:break-word;}
.dc-meal-input:focus,.dc-meal-input.focused{border-color:#C2185B;background:white;}
.dc-meal-input:empty::before{content:attr(placeholder);color:#C8A882;font-style:italic;pointer-events:none;}
.dc-meal-input.readonly{background:#F3F3F8;cursor:default;}
.notes-block{margin:0 12px 12px;background:white;border-radius:14px;padding:14px;box-shadow:var(--shadow);}
.notes-title{font-family:'Fraunces',serif;font-weight:700;font-size:1rem;margin-bottom:12px;}
.notes-cols{display:flex;flex-direction:column;gap:10px;}
.note-col-label{font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-light);margin-bottom:5px;}
.note-input{width:100%;min-height:60px;border:1.5px solid var(--border);border-radius:8px;padding:8px 10px;font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--text);background:#FAFAFD;outline:none;resize:none;transition:border 0.15s;}
.note-input:focus{border-color:#C2185B;background:white;}

/* SHARE */
.share-screen{min-height:100vh;display:flex;flex-direction:column;background:#F7F7FA;}
.share-body{flex:1;padding:16px;padding-bottom:90px;display:flex;flex-direction:column;gap:16px;}
.share-info-card{display:flex;gap:12px;background:white;border-radius:14px;padding:14px;box-shadow:var(--shadow);align-items:flex-start;}
.sic-icon{width:40px;height:40px;border-radius:10px;background:#EEF2FF;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:600;color:#1565C0;flex-shrink:0;}
.sic-text strong{display:block;font-size:0.9rem;margin-bottom:3px;}
.sic-text p{font-size:0.78rem;color:var(--text-mid);line-height:1.4;}
.share-input-row{display:flex;gap:8px;}
.share-input-row input{flex:1;padding:11px 13px;border:2px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.9rem;color:var(--text);background:var(--cream);outline:none;}
.share-input-row input:focus{border-color:#C2185B;background:white;}
.btn-share-add{padding:11px 16px;background:linear-gradient(135deg,#1565C0,#00695C);color:white;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.9rem;cursor:pointer;white-space:nowrap;}
.share-msg{font-size:0.8rem;margin-top:6px;padding:8px 10px;border-radius:8px;}
.share-msg.success{background:#E8F5E9;color:#2E7D32;}
.share-msg.error{background:#FFEBEE;color:#C62828;}
.empty-state{text-align:center;color:var(--text-light);font-size:0.85rem;padding:20px;}
.remove-btn{background:#FFEBEE;border:none;border-radius:8px;padding:6px 10px;color:#C62828;font-size:0.75rem;font-weight:700;cursor:pointer;}

/* EXPORT CARDS */
.export-section{display:flex;flex-direction:column;gap:10px;margin-bottom:4px;}
.export-card{display:flex;align-items:center;gap:14px;background:white;border-radius:14px;padding:14px 16px;box-shadow:var(--shadow);cursor:pointer;transition:all 0.15s;border:none;width:100%;font-family:'DM Sans',sans-serif;text-align:left;}
.export-card:active{transform:scale(0.98);}
.export-card-icon{width:42px;height:42px;border-radius:12px;background:#EEF2FF;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:600;color:#1565C0;flex-shrink:0;}
.export-card-text strong{display:block;font-size:0.88rem;font-weight:700;color:var(--text);}
.export-card-text span{font-size:0.75rem;color:var(--text-mid);}
.export-divider{display:flex;align-items:center;gap:10px;margin:6px 0;}
.export-divider::before,.export-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.export-divider span{font-size:0.68rem;font-weight:700;color:var(--text-light);text-transform:uppercase;letter-spacing:1px;}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid var(--border);display:flex;padding:8px 0 12px;z-index:100;box-shadow:0 -4px 20px rgba(13,13,40,0.06);}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;opacity:0.4;transition:all 0.15s;}
.nav-item.active{opacity:1;}
.nav-item.active span:first-child{color:#C2185B;}
.nav-item.active span:last-child{color:#C2185B !important;}
.nav-item span:first-child{font-size:1.3rem;color:var(--text-mid);}
.nav-item span:last-child{font-size:0.62rem;font-weight:700;color:var(--text-mid);}

/* CONFIG BANNER */
.config-banner{background:#EDE7F6;border:1.5px solid #AB47BC;border-radius:10px;padding:12px 14px;font-size:0.78rem;color:#4A235A;margin:12px;line-height:1.5;}
.config-banner strong{display:block;margin-bottom:4px;color:#6A1B9A;}
.config-banner code{background:#FEF3C7;border-radius:4px;padding:1px 5px;font-size:0.75rem;}

/* GUEST BANNER */
.guest-banner{display:flex;align-items:center;gap:10px;background:#FCE4EC;border:1.5px dashed #C2185B;border-radius:12px;padding:11px 14px;margin-bottom:16px;}
.guest-banner-text{flex:1;}
.guest-banner-title{font-size:0.82rem;font-weight:700;color:#C2185B;}
.guest-banner-sub{font-size:0.72rem;color:var(--text-mid);margin-top:2px;}
.guest-banner-cta{font-size:0.75rem;font-weight:700;color:white;background:#C2185B;border:none;border-radius:8px;padding:6px 12px;cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif;}

/* SIGNUP MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(26,15,0,0.55);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn 0.2s;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-sheet{background:white;border-radius:24px 24px 0 0;padding:28px 24px 40px;width:100%;max-width:420px;animation:slideUp 0.3s ease;}
@keyframes slideUp{from{transform:translateY(60px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-icon{font-size:2.4rem;text-align:center;margin-bottom:8px;}
.modal-title{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:700;color:#C2185B;text-align:center;margin-bottom:6px;}
.modal-sub{font-size:0.85rem;color:var(--text-mid);text-align:center;line-height:1.5;margin-bottom:20px;}
.modal-benefits{display:flex;flex-direction:column;gap:8px;margin-bottom:22px;}
.modal-benefit{display:flex;align-items:center;gap:10px;font-size:0.83rem;color:var(--text-mid);}
.modal-benefit span:first-child{font-size:1.1rem;}
.modal-actions{display:flex;flex-direction:column;gap:10px;}
.btn-ghost{background:transparent;border:2px solid var(--border);border-radius:14px;padding:13px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.9rem;color:var(--text-mid);cursor:pointer;width:100%;}
.modal-dismiss{text-align:center;margin-top:12px;font-size:0.75rem;color:var(--text-light);cursor:pointer;}

@media(min-width:480px){
  #app{max-width:420px;margin:0 auto;box-shadow:0 0 40px rgba(0,0,0,0.15);min-height:100vh;}
  .bottom-nav{max-width:420px;left:50%;transform:translateX(-50%);}
}
</style>
</head>
<body>
<div id="app"></div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged,updateProfile}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import{getFirestore,doc,setDoc,getDoc,collection,query,where,getDocs,onSnapshot,updateDoc,arrayUnion,arrayRemove,serverTimestamp}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// ‚îÄ‚îÄ‚îÄ PASTE YOUR FIREBASE CONFIG HERE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyAwwnEQqEUqOx5Y_kCexN_beKv2Qklzu4A",
  authDomain: "annapurna-12680.firebaseapp.com",
  projectId: "annapurna-12680",
  storageBucket: "annapurna-12680.firebasestorage.app",
  messagingSenderId: "223394900908",
  appId: "1:223394900908:web:cb265f757c24bc3087a809",
  measurementId: "G-TER09RGZFR"
};
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const IS_CONFIGURED = !firebaseConfig.apiKey.includes("YOUR_");

const FESTIVALS={
  "2026-01-01":[["üéâ","New Year"]],"2026-01-13":[["üî•","Lohri"]],"2026-01-14":[["üåæ","Sankranti"],["üçö","Pongal"]],
  "2026-01-23":[["üåº","Vasant Panchami"]],"2026-01-26":[["üáÆüá≥","Republic Day"]],"2026-02-14":[["‚ù§Ô∏è","Valentine's Day"]],
  "2026-02-15":[["üôè","Maha Shivratri"]],"2026-03-03":[["üî•","Holika Dahan"]],"2026-03-04":[["üé®","Holi"]],
  "2026-03-19":[["üå∏","Ugadi"]],"2026-03-20":[["üïå","Eid ul-Fitr"]],"2026-03-26":[["üôè","Ram Navami"]],
  "2026-04-03":[["‚úùÔ∏è","Good Friday"]],"2026-04-05":[["‚úùÔ∏è","Easter"]],"2026-04-14":[["üå∏","Baisakhi"]],
  "2026-05-01":[["üåï","Buddha Purnima"],["üë∑","Labour Day"]],"2026-05-27":[["üïå","Eid ul-Adha"]],
  "2026-06-17":[["üïå","Islamic New Year"]],"2026-06-26":[["üïå","Muharram"]],
  "2026-08-15":[["üáÆüá≥","Independence Day"]],"2026-08-26":[["üå∫","Onam"]],"2026-08-28":[["ü™¢","Raksha Bandhan"]],
  "2026-09-04":[["üôè","Janmashtami"]],"2026-09-14":[["üç¨","Ganesh Chaturthi"]],
  "2026-10-02":[["üïäÔ∏è","Gandhi Jayanti"]],"2026-10-11":[["üôè","Navratri"]],"2026-10-20":[["‚öîÔ∏è","Dussehra"]],"2026-10-29":[["üèÆ","Karva Chauth"]],
  "2026-11-05":[["ü™Ø","Guru Nanak Jayanti"]],"2026-11-06":[["‚ú®","Dhanteras"]],"2026-11-08":[["ü™î","Diwali"]],
  "2026-11-10":[["üèîÔ∏è","Govardhan Puja"]],"2026-11-11":[["üéÅ","Bhai Dooj"]],"2026-11-12":[["üôè","Chhath Puja"]],
  "2026-12-25":[["üéÑ","Christmas"]],"2026-12-31":[["üéä","New Year's Eve"]]
};

const MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];
const DAYS_SHORT=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const MEALS=["breakfast","lunch","snacks","dinner"];
const MEAL_ICONS={breakfast:"üåÖ",lunch:"üçõ",snacks:"ü´ñ",dinner:"üåô"};
const MONTH_COLORS=["#C2185B","#6A1B9A","#00838F","#2E7D32","#E65100","#1565C0","#00695C","#AD1457","#4527A0","#283593","#00796B","#B71C1C"];
const MONTH_GRADS=["linear-gradient(135deg,#C2185B,#E91E63)","linear-gradient(135deg,#6A1B9A,#AB47BC)","linear-gradient(135deg,#00838F,#26C6DA)","linear-gradient(135deg,#2E7D32,#66BB6A)","linear-gradient(135deg,#E65100,#FF7043)","linear-gradient(135deg,#1565C0,#42A5F5)","linear-gradient(135deg,#00695C,#26A69A)","linear-gradient(135deg,#AD1457,#F06292)","linear-gradient(135deg,#4527A0,#7E57C2)","linear-gradient(135deg,#283593,#5C6BC0)","linear-gradient(135deg,#00796B,#4DB6AC)","linear-gradient(135deg,#B71C1C,#EF5350)"];

let auth, db;
if(IS_CONFIGURED){
  const app=initializeApp(firebaseConfig);
  auth=getAuth(app); db=getFirestore(app);
}

let currentUser=null,currentView='splash',selectedMonth=new Date().getMonth(),selectedWeek=0;
let plannerData={},planOwnerId=null,unsubscribePlanner=null;
let isGuest=false; // guest mode flag

// ‚îÄ‚îÄ GUEST MODE HELPERS ‚îÄ‚îÄ
const GUEST_KEY='annapurna_guest_data';
function guestGet(){try{return JSON.parse(localStorage.getItem(GUEST_KEY)||'{}');}catch{return{};}}
function guestSet(data){try{localStorage.setItem(GUEST_KEY,JSON.stringify(data));}catch{}}
function guestMealKey(y,m,d,meal){return `${y}_${m}_${d}_${meal}`;}
function guestNoteKey(y,m,w,t){return `note_${y}_${m}_${w}_${t}`;}
function countGuestMeals(){const d=guestGet();return Object.keys(d).filter(k=>!k.startsWith('note_')).filter(k=>d[k]&&d[k].trim()).length;}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
const dateKey=d=>d.toISOString().split('T')[0];

function getWeeksInMonth(year,month){
  const first=new Date(year,month,1),last=new Date(year,month+1,0);
  const weeks=[];let cur=new Date(first);
  while(cur<=last){
    const wk=[];
    if(weeks.length===0){
      while(cur<=last){wk.push(new Date(cur));cur.setDate(cur.getDate()+1);if(cur.getDay()===1&&wk.length>0)break;}
    } else {
      while(cur<=last){wk.push(new Date(cur));cur.setDate(cur.getDate()+1);if(cur.getDay()===1)break;}
    }
    if(wk.length>0)weeks.push(wk);
  }
  return weeks;
}

function stringToColor(s){const h=s.split('').reduce((a,c)=>c.charCodeAt(0)+((a<<5)-a),0);return["#C2185B","#6A1B9A","#00695C","#1565C0","#E65100","#4527A0"][Math.abs(h)%6];}

function getMealValue(y,m,d,meal){
  if(isGuest){return guestGet()[guestMealKey(y,m,d,meal)]||'';}
  return(plannerData[`${y}_${m}`]||{})[`${d}_${meal}`]||'';
}
function getNoteValue(y,m,w,t){
  if(isGuest){return guestGet()[guestNoteKey(y,m,w,t)]||'';}
  return(plannerData[`${y}_${m}`]||{})[`note_${w}_${t}`]||'';
}

// ‚îÄ‚îÄ FIREBASE OPS ‚îÄ‚îÄ
async function saveMealEntry(y,m,d,meal,val){
  if(isGuest){
    const data=guestGet();
    data[guestMealKey(y,m,d,meal)]=val;
    guestSet(data);
    // Show save nudge after 3 meals entered
    if(countGuestMeals()===3) showSaveNudge();
    return;
  }
  if(!IS_CONFIGURED||planOwnerId||!currentUser)return;
  const ref=doc(db,'plans',`${currentUser.uid}_${y}_${m}`);
  await setDoc(ref,{[`${d}_${meal}`]:val,uid:currentUser.uid,year:y,month:m,updatedAt:serverTimestamp()},{merge:true});
}

async function saveNote(y,m,w,t,val){
  if(isGuest){
    const data=guestGet();
    data[guestNoteKey(y,m,w,t)]=val;
    guestSet(data);
    return;
  }
  if(!IS_CONFIGURED||planOwnerId||!currentUser)return;
  const ref=doc(db,'plans',`${currentUser.uid}_${y}_${m}`);
  await setDoc(ref,{[`note_${w}_${t}`]:val,uid:currentUser.uid},{merge:true});
}

function subscribeToPlan(y,m,uid){
  if(!IS_CONFIGURED)return;
  if(unsubscribePlanner)unsubscribePlanner();
  const ref=doc(db,'plans',`${uid}_${y}_${m}`);
  unsubscribePlanner=onSnapshot(ref,snap=>{
    plannerData[`${y}_${m}`]=snap.exists()?snap.data():{};
    if(currentView==='planner'||currentView==='shared-view')renderCurrentView();
  });
}

async function loadUserProfile(){
  if(!IS_CONFIGURED||!currentUser)return{};
  const snap=await getDoc(doc(db,'users',currentUser.uid));
  return snap.exists()?snap.data():{};
}

async function shareWithUser(email){
  if(!IS_CONFIGURED)throw new Error('Firebase not configured yet.');
  const q=query(collection(db,'users'),where('email','==',email.toLowerCase().trim()));
  const snap=await getDocs(q);
  if(snap.empty)throw new Error('No Annapurna account found with that email.');
  const tid=snap.docs[0].id;
  if(tid===currentUser.uid)throw new Error('You cannot share with yourself.');
  const tdata=snap.docs[0].data();
  await updateDoc(doc(db,'users',currentUser.uid),{sharedWith:arrayUnion({uid:tid,email:email.toLowerCase().trim(),name:tdata.name||email})});
  await updateDoc(doc(db,'users',tid),{sharedToMe:arrayUnion({uid:currentUser.uid,email:currentUser.email,name:currentUser.displayName||currentUser.email})});
  return tdata.name||email;
}

async function removeShare(tuid,temail){
  if(!IS_CONFIGURED)return;
  await updateDoc(doc(db,'users',currentUser.uid),{sharedWith:arrayRemove({uid:tuid,email:temail})});
  const targetSnap=await getDocs(query(collection(db,'users'),where('email','==',temail)));
  if(!targetSnap.empty){
    await updateDoc(doc(db,'users',targetSnap.docs[0].id),{sharedToMe:arrayRemove({uid:currentUser.uid,email:currentUser.email,name:currentUser.displayName||currentUser.email})});
  }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderCurrentView(){
  if(currentView==='home'){renderHome();return;}
  if(currentView==='share'){renderShareView();return;}
  const app=document.getElementById('app');
  if(currentView==='splash')app.innerHTML=renderSplash();
  else if(currentView==='auth')app.innerHTML=renderAuth('login');
  else if(currentView==='planner'||currentView==='shared-view'){app.innerHTML=renderPlanner();attachPlannerEvents();}
}

// ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ
function renderSplash(){return`<div class="splash"><div class="splash-bg"></div><div class="splash-content"><div class="splash-logo"><div class="logo-icon">ü™î</div><h1 class="logo-text">Annapurna</h1><p class="logo-tagline">Your 2026 Meal Tracker</p></div><div class="splash-features"><div class="feat-item"><span>üåæ</span> Festival-aware Indian Calendar</div><div class="feat-item"><span>üì±</span> Track meals week by week</div><div class="feat-item"><span>üëÅÔ∏è</span> Share your plan with family</div></div><button class="btn-primary full-width" onclick="window._goTo('auth')">Get Started</button><p class="splash-note">Free ¬∑ No ads ¬∑ Private</p></div></div>`;}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function renderAuth(mode){return`<div class="auth-screen"><div class="auth-header"><div class="logo-icon small">ü™î</div><h2 class="auth-title">Annapurna</h2></div><div class="auth-card">${!IS_CONFIGURED?`<div class="config-banner"><strong>‚ö†Ô∏è Firebase Setup Required</strong>Open this file in a text editor and paste your Firebase config where it says <code>YOUR_API_KEY</code> etc. <a href="https://console.firebase.google.com" target="_blank" style="color:#1A6BA0">‚Üí Get your config at Firebase Console</a></div>`:''}
<div class="auth-tabs"><button class="auth-tab ${mode==='login'?'active':''}" onclick="window._switchAuth('login')">Sign In</button><button class="auth-tab ${mode==='signup'?'active':''}" onclick="window._switchAuth('signup')">Create Account</button></div>
<div id="auth-error" class="auth-error" style="display:none"></div>
${mode==='signup'?`<div class="form-group"><label>Your Name</label><input type="text" id="auth-name" placeholder="e.g. Priya Sharma"/></div>`:''}
<div class="form-group"><label>Email</label><input type="email" id="auth-email" placeholder="you@example.com"/></div>
<div class="form-group"><label>Password</label><input type="password" id="auth-password" placeholder="${mode==='signup'?'Min 6 characters':'Your password'}"/></div>
<button class="btn-primary full-width" id="auth-submit" onclick="window._handleAuth('${mode}')">${mode==='login'?'Sign In':'Create Account'}</button>
</div>
<p style="text-align:center;margin-top:16px;font-size:0.78rem;color:var(--text-light);cursor:pointer;" onclick="window._continueAsGuest()">‚Üê Continue exploring without an account</p>
</div>`;}

window._continueAsGuest=()=>{isGuest=true;currentView='home';renderHome();};

window._switchAuth=m=>{document.getElementById('app').innerHTML=renderAuth(m);};
window._handleAuth=async mode=>{
  if(!IS_CONFIGURED){
    document.getElementById('auth-error').textContent='Please configure Firebase first (see the yellow notice above).';
    document.getElementById('auth-error').style.display='block';return;
  }
  const btn=document.getElementById('auth-submit'),err=document.getElementById('auth-error');
  const email=document.getElementById('auth-email').value.trim();
  const password=document.getElementById('auth-password').value;
  err.style.display='none';btn.disabled=true;btn.textContent='...';
  try{
    if(mode==='signup'){
      const name=document.getElementById('auth-name').value.trim();
      if(!name)throw new Error('Please enter your name.');
      const cred=await createUserWithEmailAndPassword(auth,email,password);
      await updateProfile(cred.user,{displayName:name});
      await setDoc(doc(db,'users',cred.user.uid),{email:email.toLowerCase(),name,sharedWith:[],sharedToMe:[],createdAt:serverTimestamp()});
    } else {
      await signInWithEmailAndPassword(auth,email,password);
    }
  } catch(e){
    err.textContent=e.message.replace('Firebase: ','').replace(/\(auth\/[^)]+\)/,'').trim();
    err.style.display='block';btn.disabled=false;btn.textContent=mode==='login'?'Sign In':'Create Account';
  }
};

// ‚îÄ‚îÄ HOME ‚îÄ‚îÄ
async function renderHome(){
  const today=new Date();
  let nextFest=null;
  for(let i=0;i<60;i++){const d=new Date(today);d.setDate(d.getDate()+i);const k=dateKey(d);if(FESTIVALS[k]){nextFest={date:d,fests:FESTIVALS[k],daysAway:i};break;}}
  const grad=MONTH_GRADS[today.getMonth()];
  let guestBanner='', sharedSection='', headerRight='', firstName='Friend';

  if(isGuest){
    const meals=countGuestMeals();
    guestBanner=`<div class="guest-banner">
      <div class="guest-banner-text">
        <div class="guest-banner-title">üëã You're exploring as a Guest</div>
        <div class="guest-banner-sub">${meals>0?`${meals} meal${meals===1?'':'s'} saved locally ¬∑ `:''}Create a free account to save & share</div>
      </div>
      <button class="guest-banner-cta" onclick="window._showSignupModal('save')">Save Data</button>
    </div>`;
    headerRight=`<button class="icon-btn" onclick="window._showSignupModal('save')" style="background:rgba(255,255,255,0.2);color:white;font-size:0.75rem;font-weight:700;width:auto;padding:0 10px;">Sign In</button>`;
  } else {
    const profile=await loadUserProfile();
    const name=currentUser?.displayName||'Friend';
    firstName=name.split(' ')[0];
    const sharedToMe=profile.sharedToMe||[];
    sharedSection=sharedToMe.length>0?`<div class="section-label" style="margin-top:24px">Shared With Me</div><div class="shared-list">${sharedToMe.map(p=>`<div class="shared-card" onclick="window._viewSharedPlan('${p.uid}','${p.name||p.email}')"><div class="shared-avatar" style="background:${stringToColor(p.email)}">${(p.name||p.email)[0].toUpperCase()}</div><div class="shared-info"><div class="shared-name">${p.name||p.email}</div><div class="shared-email">${p.email}</div></div><div class="shared-arrow">üëÅÔ∏è</div></div>`).join('')}</div>`:'';
    headerRight=`<button class="icon-btn" onclick="window._signOut()" title="Sign out" style="background:rgba(255,255,255,0.2);color:white;font-size:0.75rem;font-weight:700;width:auto;padding:0 10px;">Sign Out</button>`;
  }

  document.getElementById('app').innerHTML=`
  <div class="home-screen">
    <div class="home-header" style="background:${grad}">
      <div class="home-header-top">
        <div><p class="home-greeting">Namaste, ${firstName} üôè</p><p class="home-date">${today.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long'})}</p></div>
        ${headerRight}
      </div>
      ${nextFest?`<div class="festival-chip">${nextFest.fests[0][0]} ${nextFest.daysAway===0?'Today: ':nextFest.daysAway===1?'Tomorrow: ':`In ${nextFest.daysAway} days: `}<strong>${nextFest.fests.map(f=>f[1]).join(' & ')}</strong></div>`:''}
    </div>
    <div class="home-body">
      ${guestBanner}
      <div class="section-label" style="margin-bottom:10px">My Meal Plan ‚Äî 2026</div>
      <div class="month-grid">${MONTHS.map((m,i)=>`<div class="month-card" onclick="window._openMyPlanner(${i})"><div class="mc-bar" style="background:${MONTH_GRADS[i]}"></div><div class="mc-body"><div class="mc-name">${m.slice(0,3)}</div><div class="mc-dot" style="background:${MONTH_COLORS[i]}"></div></div></div>`).join('')}</div>
      ${sharedSection}
      <div class="section-label" style="margin-top:24px">Sharing</div>
      <button class="share-btn" onclick="window._handleShareClick()"><span class="share-btn-icon">‚ú¶</span><span>Share My Plan with Someone</span></button>
    </div>
    <div class="bottom-nav">
      <div class="nav-item active"><span>‚åÇ</span><span>Home</span></div>
      <div class="nav-item" onclick="window._openMyPlanner(${today.getMonth()})"><span>üìÜ</span><span>Planner</span></div>
      <div class="nav-item" onclick="window._handleShareClick()"><span>‚ú¶</span><span>Share</span></div>
    </div>
  </div>`;
}

window._openMyPlanner=m=>{
  planOwnerId=null;selectedMonth=m;selectedWeek=0;currentView='planner';
  if(!isGuest) subscribeToPlan(2026,m,currentUser.uid);
  renderCurrentView();
};

// ‚îÄ‚îÄ SHARE GATE ‚îÄ‚îÄ
window._handleShareClick=()=>{
  if(isGuest){showSignupModal('share');return;}
  window._goTo('share');
};

// ‚îÄ‚îÄ SIGNUP MODAL ‚îÄ‚îÄ
function showSignupModal(trigger){
  const isShare=trigger==='share';
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.id='signup-modal';
  overlay.innerHTML=`<div class="modal-sheet">
    <div class="modal-icon">${isShare?'‚ú¶':'üîê'}</div>
    <div class="modal-title">${isShare?'Share Your Meal Plan':'Save Your Meal Plan'}</div>
    <div class="modal-sub">${isShare?'Create a free account to share your plan with family and friends.':'You\'ve been building your plan! Create a free account so your data is saved forever ‚Äî not just on this device.'}</div>
    <div class="modal-benefits">
      <div class="modal-benefit"><span>‚òÅÔ∏è</span> Your meals saved securely to the cloud</div>
      <div class="modal-benefit"><span>‚ú¶</span> Share your plan with family</div>
      <div class="modal-benefit"><span>üì±</span> Access from any device</div>
      <div class="modal-benefit"><span>üÜì</span> Completely free, no credit card</div>
    </div>
    <div class="modal-actions">
      <button class="btn-primary full-width" onclick="window._modalGoAuth('signup')">Create Free Account ‚Üí</button>
      <button class="btn-ghost" onclick="window._modalGoAuth('login')">I already have an account</button>
    </div>
    <div class="modal-dismiss" onclick="document.getElementById('signup-modal').remove()">Maybe later ‚Äî keep exploring</div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.remove();});
}
window._showSignupModal=showSignupModal;
window._modalGoAuth=mode=>{
  document.getElementById('signup-modal')?.remove();
  currentView='auth';
  document.getElementById('app').innerHTML=renderAuth(mode);
};
function showSaveNudge(){
  // Only show once
  if(sessionStorage.getItem('nudge_shown'))return;
  sessionStorage.setItem('nudge_shown','1');
  setTimeout(()=>showSignupModal('save'),800);
}
window._viewSharedPlan=(uid,name)=>{planOwnerId=uid;selectedMonth=new Date().getMonth();selectedWeek=0;currentView='shared-view';subscribeToPlan(2026,selectedMonth,uid);renderCurrentView();};
window._signOut=async()=>{if(unsubscribePlanner)unsubscribePlanner();await signOut(auth);};
window._goTo=v=>{currentView=v;renderCurrentView();};
window._backToHome=()=>{if(unsubscribePlanner){unsubscribePlanner();unsubscribePlanner=null;}planOwnerId=null;currentView='home';renderHome();};

// ‚îÄ‚îÄ PLANNER ‚îÄ‚îÄ
function renderPlanner(){
  const y=2026,m=selectedMonth,color=MONTH_COLORS[m],grad=MONTH_GRADS[m];
  const weeks=getWeeksInMonth(y,m),week=weeks[selectedWeek]||weeks[0];
  const isRO=!!planOwnerId;
  const festsWeek=[];week.forEach(d=>{const k=dateKey(d);if(FESTIVALS[k])FESTIVALS[k].forEach(f=>festsWeek.push(f));});
  return`<div class="planner-screen">
  <div class="planner-topbar" style="background:${grad}">
    <button class="icon-btn light" onclick="window._backToHome()" style="font-size:1.3rem;font-weight:300;">‚åÇ</button>
    <div class="planner-title"><div class="pt-month">${MONTHS[m]} 2026</div>${isRO?`<div class="pt-shared">üëÅÔ∏è Viewing shared plan</div>`:''}</div>
    ${!isRO?`<button class="icon-btn light" onclick="window._goTo('share')" style="font-size:1rem;font-weight:500;">‚ú¶</button>`:`<div style="width:48px"></div>`}
  </div>
  <div class="month-strip" id="month-strip-scroll">${MONTHS.map((mn,i)=>`<div class="ms-item ${i===m?'active':''}" onclick="window._changeMonth(${i})" style="${i===m?`background:${color};color:white`:''}">${mn.slice(0,3)}</div>`).join('')}</div>
  <div class="week-tabs">${weeks.map((w,i)=>{const s=w[0],e=w[w.length-1],hf=w.some(d=>FESTIVALS[dateKey(d)]);return`<div class="wt-item ${i===selectedWeek?'active':''}" onclick="window._changeWeek(${i})" style="${i===selectedWeek?`border-bottom:2.5px solid ${color};color:${color}`:''}">W${i+1}${hf?`<span class="wt-dot" style="background:${color}"></span>`:''}<span class="wt-dates">${DAYS_SHORT[s.getDay()]} ${s.getDate()}‚Äì${DAYS_SHORT[e.getDay()]} ${e.getDate()}</span></div>`;}).join('')}</div>
  ${festsWeek.length>0?`<div class="fest-banner" style="background:${grad}">${festsWeek.map(f=>`${f[0]} ${f[1]}`).join(' ¬∑ ')}</div>`:''}
  <div class="day-cards">${week.map(d=>renderDayCard(d,y,m,color,isRO)).join('')}</div>
  <div class="notes-block">
    <div class="notes-title" style="color:${color}">üìù Week Notes</div>
    <div class="notes-cols">
      <div class="note-col"><div class="note-col-label">üõí Groceries</div><textarea class="note-input" ${isRO?'readonly':''} onblur="window._saveNote(${y},${m},${selectedWeek},'g',this.value)" placeholder="Groceries...">${getNoteValue(y,m,selectedWeek,'g')}</textarea></div>
      <div class="note-col"><div class="note-col-label">üí° Prep Tips</div><textarea class="note-input" ${isRO?'readonly':''} onblur="window._saveNote(${y},${m},${selectedWeek},'p',this.value)" placeholder="Prep notes...">${getNoteValue(y,m,selectedWeek,'p')}</textarea></div>
      <div class="note-col"><div class="note-col-label">üéä Festival Notes</div><textarea class="note-input" ${isRO?'readonly':''} onblur="window._saveNote(${y},${m},${selectedWeek},'f',this.value)" placeholder="Festival notes...">${getNoteValue(y,m,selectedWeek,'f')}</textarea></div>
    </div>
  </div>
  <div style="height:80px"></div>
  <div class="bottom-nav">
    <div class="nav-item" onclick="window._backToHome()"><span>‚åÇ</span><span>Home</span></div>
    <div class="nav-item active"><span>üìÜ</span><span>Planner</span></div>
    <div class="nav-item" onclick="window._goTo('share')"><span>‚ú¶</span><span>Share</span></div>
  </div></div>`;
}

function renderDayCard(d,y,m,color,isRO){
  const day=d.getDate(),dk=dateKey(d),fests=FESTIVALS[dk];
  const isWeekend=d.getDay()===0||d.getDay()===6,isToday=dk===dateKey(new Date());
  return`<div class="day-card">
  <div class="dc-header" style="${fests?`background:${color}10;border-left:3px solid ${color}`:`border-left:3px solid #eee`}">
    <div class="dc-date-block"><div class="dc-dayname">${DAYS_SHORT[d.getDay()]}</div><div class="dc-daynum" style="color:${fests||isToday?color:'#2C1A0E'}">${day}</div></div>
    <div class="dc-fest-tags">
      ${isToday?'<span class="dc-today-tag">Today</span>':''}
      ${fests?fests.map(f=>`<span class="dc-fest-tag" style="background:${color}20;color:${color}">${f[0]} ${f[1]}</span>`).join(''):''}
      ${isWeekend&&!fests?'<span class="dc-weekend-tag">Weekend</span>':''}
    </div>
  </div>
  <div class="dc-meals">${MEALS.map(meal=>`<div class="dc-meal-row"><div class="dc-meal-label">${MEAL_ICONS[meal]}</div><div class="dc-meal-input ${isRO?'readonly':''}" ${!isRO?'contenteditable="true"':''} data-key="${y}_${m}_${day}_${meal}" ${!isRO?'onblur="window._mealBlur(this)"':''} placeholder="${meal.charAt(0).toUpperCase()+meal.slice(1)}...">${getMealValue(y,m,day,meal)}</div></div>`).join('')}
  </div></div>`;
}

function attachPlannerEvents(){
  document.querySelectorAll('.dc-meal-input[contenteditable]').forEach(el=>{el.addEventListener('focus',()=>el.classList.add('focused'));el.addEventListener('blur',()=>el.classList.remove('focused'));});
  const strip=document.getElementById('month-strip-scroll');
  if(strip){const active=strip.querySelector('.ms-item.active');if(active)active.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});}
}

window._mealBlur=async el=>{const[y,m,d,meal]=el.dataset.key.split('_');await saveMealEntry(+y,+m,+d,meal,el.innerText.trim());};
window._saveNote=async(y,m,w,t,v)=>{await saveNote(y,m,w,t,v);};
// ‚îÄ‚îÄ SURGICAL PLANNER UPDATES (no full re-render flash) ‚îÄ‚îÄ
function updatePlannerInPlace(){
  const y=2026,m=selectedMonth,color=MONTH_COLORS[m],grad=MONTH_GRADS[m];
  const weeks=getWeeksInMonth(y,m),week=weeks[selectedWeek]||weeks[0];
  const isRO=!!planOwnerId;
  const festsWeek=[];week.forEach(d=>{const k=dateKey(d);if(FESTIVALS[k])FESTIVALS[k].forEach(f=>festsWeek.push(f));});

  // Update topbar gradient + month title
  const topbar=document.querySelector('.planner-topbar');
  if(topbar) topbar.style.background=grad;
  const ptMonth=document.querySelector('.pt-month');
  if(ptMonth) ptMonth.textContent=`${MONTHS[m]} 2026`;

  // Update month strip active state
  const strip=document.getElementById('month-strip-scroll');
  if(strip){
    strip.querySelectorAll('.ms-item').forEach((el,i)=>{
      el.className=`ms-item${i===m?' active':''}`;
      el.style.background=i===m?color:'';
      el.style.color=i===m?'white':'';
    });
    const active=strip.querySelector('.ms-item.active');
    if(active) active.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
  }

  // Update week tabs
  const weekTabsEl=document.querySelector('.week-tabs');
  if(weekTabsEl){
    weekTabsEl.innerHTML=weeks.map((w,i)=>{
      const s=w[0],e=w[w.length-1],hf=w.some(d=>FESTIVALS[dateKey(d)]);
      return`<div class="wt-item ${i===selectedWeek?'active':''}" onclick="window._changeWeek(${i})" style="${i===selectedWeek?`border-bottom:2.5px solid ${color};color:${color}`:''}">W${i+1}${hf?`<span class="wt-dot" style="background:${color}"></span>`:''}<span class="wt-dates">${DAYS_SHORT[s.getDay()]} ${s.getDate()}‚Äì${DAYS_SHORT[e.getDay()]} ${e.getDate()}</span></div>`;
    }).join('');
  }

  // Update festival banner
  let festBanner=document.querySelector('.fest-banner');
  if(festsWeek.length>0){
    if(!festBanner){
      festBanner=document.createElement('div');
      festBanner.className='fest-banner';
      document.querySelector('.week-tabs')?.after(festBanner);
    }
    festBanner.style.background=grad;
    festBanner.textContent=festsWeek.map(f=>`${f[0]} ${f[1]}`).join(' ¬∑ ');
  } else {
    festBanner?.remove();
  }

  // Update day cards
  const dayCardsEl=document.querySelector('.day-cards');
  if(dayCardsEl) dayCardsEl.innerHTML=week.map(d=>renderDayCard(d,y,m,color,isRO)).join('');

  // Update notes
  const notesTitle=document.querySelector('.notes-title');
  if(notesTitle) notesTitle.style.color=color;
  const noteAreas=document.querySelectorAll('.note-input');
  const noteTypes=['g','p','f'];
  noteAreas.forEach((ta,i)=>{
    ta.value=getNoteValue(y,m,selectedWeek,noteTypes[i]);
    ta.setAttribute('onblur',`window._saveNote(${y},${m},${selectedWeek},'${noteTypes[i]}',this.value)`);
  });

  attachPlannerEvents();
}

window._changeMonth=m=>{
  selectedMonth=m;selectedWeek=0;
  if(!isGuest) subscribeToPlan(2026,m,planOwnerId||currentUser.uid);
  if(document.querySelector('.planner-screen')) updatePlannerInPlace();
  else renderCurrentView();
};
window._changeWeek=w=>{
  selectedWeek=w;
  if(document.querySelector('.planner-screen')) updatePlannerInPlace();
  else renderCurrentView();
};

// ‚îÄ‚îÄ SHARE SCREEN ‚îÄ‚îÄ
async function renderShareView(){
  const profile=await loadUserProfile();
  const sharedWith=profile.sharedWith||[];
  const canNativeShare=!!navigator.share;
  document.getElementById('app').innerHTML=`<div class="share-screen">
  <div class="planner-topbar" style="background:linear-gradient(135deg,#1565C0,#00695C)">
    <button class="icon-btn light" onclick="window._backToHome()" style="font-size:1.3rem;font-weight:300;">‚åÇ</button>
    <div class="planner-title"><div class="pt-month">‚ú¶ Share My Plan</div></div>
    <div style="width:48px"></div>
  </div>
  <div class="share-body">

    <div class="section-label">Share Without an Account</div>
    <div class="export-section">
      <button class="export-card" onclick="window._downloadMonthImage()">
        <div class="export-card-icon">‚¨á</div>
        <div class="export-card-text"><strong>Download This Week as Image</strong><span>Saves current week as a PNG ‚Äî easy to send on WhatsApp</span></div>
      </button>
      ${canNativeShare?`<button class="export-card" onclick="window._nativeShare()">
        <div class="export-card-icon">‚ú¶</div>
        <div class="export-card-text"><strong>Share via WhatsApp / Messages</strong><span>Opens your phone's share sheet</span></div>
      </button>`:''}
      <button class="export-card" onclick="window._copyTextPlan()">
        <div class="export-card-icon">‚éò</div>
        <div class="export-card-text"><strong>Copy as Text</strong><span>Copy this week's meals to paste anywhere</span></div>
      </button>
    </div>

    <div class="export-divider"><span>or invite to app</span></div>

    <div class="share-info-card"><div class="sic-icon">üë§</div><div class="sic-text"><strong>Invite by Annapurna account</strong><p>They can view your live plan anytime ‚Äî updates automatically.</p></div></div>
    ${!IS_CONFIGURED?`<div class="config-banner"><strong>‚ö†Ô∏è Firebase not configured</strong>Share feature requires Firebase setup.</div>`:''}
    <div class="form-group"><label>Invite by Email</label><div class="share-input-row"><input type="email" id="share-email" placeholder="friend@example.com"/><button class="btn-share-add" onclick="window._handleShareAdd()">Add</button></div><div id="share-msg" class="share-msg" style="display:none"></div></div>
    <div class="section-label">Currently Shared With</div>
    <div id="shared-list">${sharedWith.length===0?`<div class="empty-state">Not shared with anyone yet.</div>`:sharedWith.map(p=>`<div class="shared-card" id="sc_${p.uid}"><div class="shared-avatar" style="background:${stringToColor(p.email)}">${(p.name||p.email)[0].toUpperCase()}</div><div class="shared-info"><div class="shared-name">${p.name||p.email}</div><div class="shared-email">${p.email}</div></div><button class="remove-btn" onclick="window._removeShare('${p.uid}','${p.email}')">‚úï Remove</button></div>`).join('')}</div>
  </div>
  <div class="bottom-nav">
    <div class="nav-item" onclick="window._backToHome()"><span>üè†</span><span>Home</span></div>
    <div class="nav-item" onclick="window._openMyPlanner(${selectedMonth})"><span>üìÖ</span><span>Planner</span></div>
    <div class="nav-item active"><span>‚ú¶</span><span>Share</span></div>
  </div></div>`;
}

// ‚îÄ‚îÄ EXPORT HELPERS ‚îÄ‚îÄ

// Build a readable text summary of current week
function buildTextPlan(){
  const y=2026,m=selectedMonth;
  const weeks=getWeeksInMonth(y,m),week=weeks[selectedWeek]||weeks[0];
  const color=MONTH_COLORS[m];
  let lines=[`ü™î Annapurna Meal Plan ‚Äî ${MONTHS[m]} 2026, Week ${selectedWeek+1}`,`${'‚îÄ'.repeat(36)}`];
  week.forEach(d=>{
    const day=d.getDate(),dk=dateKey(d),fests=FESTIVALS[dk];
    lines.push(`\n${DAYS_SHORT[d.getDay()]} ${day}${fests?' '+fests.map(f=>f[0]+' '+f[1]).join(', '):''}`);
    MEALS.forEach(meal=>{
      const val=getMealValue(y,m,day,meal);
      if(val) lines.push(`  ${MEAL_ICONS[meal]} ${meal.charAt(0).toUpperCase()+meal.slice(1)}: ${val}`);
    });
  });
  return lines.join('\n');
}

window._copyTextPlan=async()=>{
  const text=buildTextPlan();
  try{
    await navigator.clipboard.writeText(text);
    // Brief visual feedback
    const btn=document.querySelectorAll('.export-card')[document.querySelectorAll('.export-card').length-1];
    const orig=btn.querySelector('strong').textContent;
    btn.querySelector('strong').textContent='‚úÖ Copied!';
    setTimeout(()=>btn.querySelector('strong').textContent=orig,2000);
  } catch(e){alert('Could not copy. Please copy manually:\n\n'+text);}
};

window._nativeShare=async()=>{
  const text=buildTextPlan();
  try{await navigator.share({title:'My Annapurna Meal Plan ü™î',text});}
  catch(e){}
};

window._downloadMonthImage=async()=>{
  const y=2026,m=selectedMonth,color=MONTH_COLORS[m],grad=MONTH_GRADS[m];
  const weeks=getWeeksInMonth(y,m);
  const week=weeks[selectedWeek]||weeks[0]; // current week only
  const btn=document.querySelectorAll('.export-card')[0];
  const origText=btn.querySelector('strong').textContent;
  btn.querySelector('strong').textContent='‚è≥ Generating...';
  btn.disabled=true;

  // Canvas dimensions based on single week
  const W=800,PADDING=28,HEADER_H=90,DAY_CARD_H=120,FOOTER_H=40;
  const H=HEADER_H + week.length*DAY_CARD_H + FOOTER_H + PADDING*2;

  const canvas=document.createElement('canvas');
  canvas.width=W; canvas.height=H;
  const ctx=canvas.getContext('2d');

  // Background gradient
  const bgGrad=ctx.createLinearGradient(0,0,0,H);
  bgGrad.addColorStop(0,'#FFF8EE'); bgGrad.addColorStop(1,'#FFE8C8');
  ctx.fillStyle=bgGrad; ctx.fillRect(0,0,W,H);

  // Header bar
  const hGrad=ctx.createLinearGradient(0,0,W,0);
  const [c1,c2]=grad.match(/#[0-9a-fA-F]{6}/g)||[color,color];
  hGrad.addColorStop(0,c1); hGrad.addColorStop(1,c2);
  ctx.fillStyle=hGrad;
  ctx.beginPath(); ctx.roundRect(PADDING,PADDING,W-PADDING*2,62,16); ctx.fill();

  // Header text
  ctx.fillStyle='white'; ctx.textAlign='center';
  ctx.font='bold 20px serif';
  ctx.fillText('ü™î Annapurna ‚Äî '+MONTHS[m]+' 2026', W/2, PADDING+28);
  ctx.font='13px sans-serif'; ctx.globalAlpha=0.85;
  const ws=week[0],we=week[week.length-1];
  ctx.fillText('Week '+(selectedWeek+1)+' ¬∑ '+DAYS_SHORT[ws.getDay()]+' '+ws.getDate()+' ‚Äì '+DAYS_SHORT[we.getDay()]+' '+we.getDate(), W/2, PADDING+50);
  ctx.globalAlpha=1;

  // Day cards
  let y2=HEADER_H+PADDING;
  week.forEach(d=>{
    const dk=dateKey(d),fests=FESTIVALS[dk];
    const isToday=dk===dateKey(new Date());

    // Card background
    ctx.fillStyle='white';
    ctx.shadowColor='rgba(92,51,23,0.08)'; ctx.shadowBlur=8; ctx.shadowOffsetY=2;
    ctx.beginPath(); ctx.roundRect(PADDING,y2,W-PADDING*2,DAY_CARD_H-8,12); ctx.fill();
    ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetY=0;

    // Left accent bar
    ctx.fillStyle=fests||isToday?color:'#eee';
    ctx.beginPath(); ctx.roundRect(PADDING,y2,4,DAY_CARD_H-8,4); ctx.fill();

    // Day name + number
    ctx.fillStyle='#9E7A56'; ctx.font='bold 10px sans-serif'; ctx.textAlign='left';
    ctx.fillText(DAYS_SHORT[d.getDay()].toUpperCase(), PADDING+16, y2+18);
    ctx.fillStyle=fests||isToday?color:'#1A0F00';
    ctx.font='bold 26px serif';
    ctx.fillText(d.getDate(), PADDING+16, y2+48);

    // Festival tag
    if(fests){
      ctx.fillStyle=color+'22';
      ctx.beginPath(); ctx.roundRect(PADDING+60,y2+10,180,22,11); ctx.fill();
      ctx.fillStyle=color; ctx.font='bold 11px sans-serif';
      ctx.fillText(fests[0][0]+' '+fests[0][1], PADDING+70, y2+25);
    }

    // Meal values ‚Äî 2 columns x 2 rows
    const mealPositions=[
      [PADDING+60, y2+46],
      [PADDING+60+((W-PADDING*2-80)/2), y2+46],
      [PADDING+60, y2+78],
      [PADDING+60+((W-PADDING*2-80)/2), y2+78],
    ];
    MEALS.forEach((meal,mi)=>{
      const val=getMealValue(y,m,d.getDate(),meal);
      const [mx,my]=mealPositions[mi];
      ctx.fillStyle='#C8A882'; ctx.font='10px sans-serif';
      ctx.fillText(MEAL_ICONS[meal]+' '+meal.charAt(0).toUpperCase()+meal.slice(1), mx, my);
      ctx.fillStyle=val?'#1A0F00':'#D4B896';
      ctx.font=val?'12px sans-serif':'italic 11px sans-serif';
      ctx.fillText(val||'‚Äî', mx, my+16);
    });

    y2+=DAY_CARD_H;
  });

  // Footer
  ctx.fillStyle='#C8A882'; ctx.font='11px sans-serif'; ctx.textAlign='center';
  ctx.fillText('Made with Annapurna ü™î  ¬∑  annapurna.app', W/2, H-14);

  // Download
  canvas.toBlob(blob=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`annapurna-${MONTHS[m].toLowerCase()}-week${selectedWeek+1}.png`;
    a.click();
    btn.querySelector('strong').textContent='‚úÖ Downloaded!';
    btn.disabled=false;
    setTimeout(()=>btn.querySelector('strong').textContent=origText,2500);
  });
};

window._handleShareAdd=async()=>{
  const ei=document.getElementById('share-email'),btn=document.querySelector('.btn-share-add'),msg=document.getElementById('share-msg');
  const email=ei.value.trim();if(!email)return;
  btn.disabled=true;btn.textContent='...';msg.style.display='none';
  try{const name=await shareWithUser(email);msg.className='share-msg success';msg.textContent=`‚úÖ ${name} can now view your meal plan!`;msg.style.display='block';ei.value='';setTimeout(()=>renderShareView(),1500);}
  catch(e){msg.className='share-msg error';msg.textContent=`‚ùå ${e.message}`;msg.style.display='block';}
  btn.disabled=false;btn.textContent='Add';
};
window._removeShare=async(uid,email)=>{const c=document.getElementById(`sc_${uid}`);if(c)c.style.opacity='0.3';await removeShare(uid,email);renderShareView();};

// ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ
if(IS_CONFIGURED){
  onAuthStateChanged(auth,user=>{
    currentUser=user;
    if(user){
      isGuest=false;
      currentView='home';
      renderHome();
    } else {
      // No logged-in user ‚Üí go straight to app as guest
      isGuest=true;
      currentView='home';
      renderHome();
    }
  });
} else {
  // Firebase not configured ‚Äî still allow guest mode
  isGuest=true;
  currentView='home';
  renderHome();
}
</script>
</body>
</html>
